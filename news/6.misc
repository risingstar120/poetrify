Add some tests and refactored drastically.
